import{ag as M,u as C,r as D,aB as E,j as e,B as o,aC as P}from"./index-DNwfBDY0.js";import{A as T}from"./arrow-left-CUel7EGd.js";const L=()=>{var N;const v=M(),m=C(),{address:i,order:t,payment:y,coupon:n}=v.state||{},[h,c]=D.useState(!1),[g,{isLoading:b}]=E();if(!i||!t||!y)return e.jsx("div",{className:"text-center mt-20 text-xl font-semibold text-red-600",children:"Missing required information. Please return to the checkout page."});const k=()=>new Promise(d=>{const l=document.createElement("script");l.src="https://checkout.razorpay.com/v1/checkout.js",l.onload=()=>d(!0),l.onerror=()=>d(!1),document.body.appendChild(l)}),z=async()=>{var d,l,_;if(!(h||b))try{c(!0);const p=Math.round((n?u:t.total)*100);if(y.paymentMethod==="online"){if(y.onlinePaymentMethod==="razorpay"){if(!await k()){o.error("Razorpay SDK failed to load. Please try again later."),c(!1);return}let a;try{const s={address:i,order:t,couponCode:n?n.couponCode:null,payment:{paymentMethod:"razorpay",onlinePaymentMethod:"razorpay"},productId:null,quantity:null};a=await g(s).unwrap()}catch(s){console.error("Error creating order:",s),o.error("Failed to create order. Please try again."),c(!1);return}const f={key:"rzp_test_S0cXdT2gxTqG7n",amount:p,currency:"INR",name:"Test Business",description:"Test Transaction",image:"https://example.com/logo.png",order_id:a.razorpayOrderId,handler:async function(s){try{await(await P(async()=>{const{default:w}=await import("./index-BBTKOM0z.js");return{default:w}},[])).default.post("/api/userProfile/verify-razorpay-payment",{razorpay_payment_id:s.razorpay_payment_id,razorpay_order_id:s.razorpay_order_id||a.razorpayOrderId,razorpay_signature:s.razorpay_signature,orderId:a.orderId,amount:p/100}),o.success("Payment successful!"),m("/payment-success",{state:{paymentId:a.paymentId,orderId:a.orderId}})}catch(x){console.error("Error verifying payment:",x),o.error("Payment verification failed. Please contact support."),m("/payment-failure",{state:{orderId:a.orderId,reason:"Payment verification failed",amount:p/100}})}finally{c(!1)}},modal:{ondismiss:async function(){o.warning("Payment cancelled. You can retry anytime from your orders.");try{await(await P(async()=>{const{default:x}=await import("./index-BBTKOM0z.js");return{default:x}},[])).default.post("/api/userProfile/mark-payment-failed",{orderId:a.orderId,reason:"Payment cancelled by user"})}catch(s){console.error("Error marking payment as failed:",s)}m("/payment-failure",{state:{orderId:a.orderId,reason:"Payment cancelled by user",amount:p/100,orderDetails:t,canRetry:!0}}),c(!1)}},theme:{color:"#3399cc"}},I=new window.Razorpay(f);I.on("payment.failed",async function(s){o.error("Payment failed. Please try again.");try{await(await P(async()=>{const{default:w}=await import("./index-BBTKOM0z.js");return{default:w}},[])).default.post("/api/userProfile/mark-payment-failed",{orderId:a.orderId,reason:s.error.description||"Payment failed"})}catch(x){console.error("Error marking payment as failed:",x)}m("/payment-failure",{state:{orderId:a.orderId,reason:s.error.description||"Payment failed",amount:p/100,orderDetails:t}}),c(!1)}),I.open()}else if(y.onlinePaymentMethod==="card")try{const r={address:i,order:t,couponCode:n?n.couponCode:null,payment:{paymentMethod:"card",onlinePaymentMethod:"card"},productId:null,quantity:null},a=await g(r).unwrap();o.success("Wallet payment successful!"),m("/payment-success",{state:{paymentId:a.paymentId,orderId:a.orderId}})}catch(r){const a=((d=r==null?void 0:r.data)==null?void 0:d.message)||"Wallet payment failed.";o.error(a),m("/payment-failure",{state:{orderId:(l=r==null?void 0:r.data)==null?void 0:l.orderId,reason:a,amount:n?u:t.total,orderDetails:t,canRetry:(_=r==null?void 0:r.data)==null?void 0:_.canRetry},replace:!0})}finally{c(!1)}}else y.paymentMethod==="cod"?(o.info("Cash on Delivery selected. Confirming order..."),setTimeout(async()=>{var r;try{const a={address:i,order:t,couponCode:n?n.couponCode:null,payment:{paymentMethod:"cod",onlinePaymentMethod:null},productId:null,quantity:null},f=await g(a).unwrap();m("/payment-success",{state:{paymentId:f.paymentId,orderId:f.orderId}})}catch(a){o.error(((r=a==null?void 0:a.data)==null?void 0:r.message)||"Failed to process the order."),c(!1)}},1500)):(o.error("Invalid payment method selected."),c(!1))}catch(p){console.error("An error occurred:",p),o.error("An unexpected error occurred."),c(!1)}},u=n?t.total-t.total*(n.discount/100):t.total,j=n?t.total*(n.discount/100):0;return!i||!t||!y?e.jsx("div",{className:"text-center mt-10 sm:mt-20 px-4 text-base sm:text-xl font-semibold text-red-600",children:"Missing required information. Please return to the checkout page."}):e.jsx("div",{className:"container mx-auto py-6 sm:py-8 md:py-10 px-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 sm:p-6 md:p-8 rounded-lg shadow-lg max-w-3xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 sm:gap-0 mb-6 sm:mb-8",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold text-green-600 dark:text-green-300",children:"Proceed to Payment"}),e.jsxs("button",{onClick:()=>m(-1),className:"flex items-center text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white text-sm sm:text-base",children:[e.jsx(T,{className:"mr-2 h-4 w-4 sm:h-5 sm:w-5"}),e.jsx("span",{children:"Back to Checkout"})]})]}),e.jsxs("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 border border-gray-300 dark:border-gray-700 rounded-md",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Shipping Address"}),e.jsxs("div",{className:"mt-2 text-sm sm:text-base text-gray-700 dark:text-gray-300 space-y-1",children:[e.jsx("p",{className:"break-words",children:i.line1}),e.jsxs("p",{children:[i.city,", ",i.state,", ",i.zip]}),e.jsx("p",{children:i.country})]})]}),e.jsxs("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 border border-gray-300 dark:border-gray-700 rounded-md",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Order Summary"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[t.cartItems.map(d=>{var l;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between py-2 border-b border-gray-200 dark:border-gray-600",children:[e.jsx("span",{className:"text-sm sm:text-base text-gray-700 dark:text-gray-300 break-words mb-1 sm:mb-0",children:d.productName}),e.jsxs("span",{className:"text-sm sm:text-base text-gray-700 dark:text-gray-300 whitespace-nowrap",children:[d.quantity," x ₹",(l=d.offerPrice||d.originalPrice)==null?void 0:l.toFixed(2)]})]},d.id)}),e.jsxs("div",{className:"flex justify-between py-2 mt-2 sm:mt-4",children:[e.jsx("span",{className:"text-sm sm:text-base font-semibold",children:"Total (Inc. Tax & Shipping)"}),e.jsxs("span",{className:"text-sm sm:text-base text-gray-700 dark:text-gray-300 whitespace-nowrap",children:["₹ ",t!=null&&t.total?t==null?void 0:t.total:(N=t==null?void 0:t.total)==null?void 0:N.toFixed(2)]})]}),typeof j=="number"&&!isNaN(j)&&e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-sm sm:text-base font-semibold",children:"Discount"}),e.jsxs("span",{className:"text-sm sm:text-base text-gray-700 dark:text-gray-300 whitespace-nowrap",children:["₹ ",j.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-sm sm:text-base font-semibold",children:"Total after Discount"}),e.jsxs("span",{className:"font-semibold text-lg sm:text-xl text-gray-900 dark:text-gray-100 whitespace-nowrap",children:["₹",typeof u=="number"&&!isNaN(u)?u.toFixed(2):u]})]})]})]}),e.jsxs("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 border border-gray-300 dark:border-gray-700 rounded-md",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Payment Method"}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"cod",name:"paymentMethod",checked:y.paymentMethod==="cod",onChange:()=>{},className:"mr-3 h-4 w-4"}),e.jsx("label",{htmlFor:"cod",className:"text-sm sm:text-base text-gray-700 dark:text-gray-300",children:"Cash on Delivery"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"online",name:"paymentMethod",checked:y.paymentMethod==="online",onChange:()=>{},className:"mr-3 h-4 w-4"}),e.jsx("label",{htmlFor:"online",className:"text-sm sm:text-base text-gray-700 dark:text-gray-300",children:"Online Payment"})]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:z,className:"w-full sm:w-auto bg-green-600 text-white py-2.5 sm:py-3 px-4 sm:px-6 rounded-md hover:bg-green-700 transition duration-300 text-sm sm:text-base",disabled:b||h,children:b||h?"Processing...":"Confirm Payment"})})]})})};export{L as default};
