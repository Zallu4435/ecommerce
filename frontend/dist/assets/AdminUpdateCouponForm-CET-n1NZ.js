import{am as D,u as ee,bg as te,r as o,aU as se,bf as re,H as ae,j as e,L as ie,at as m,aw as oe,I as ne,B as P}from"./index-DNwfBDY0.js";import{b as de,a as le}from"./CouponApiSlice-9zeQ3mce.js";import{I as n,L as d,a as u,T as ce}from"./StyledComponents-BbiIQNic.js";import{U as me,P as ue,c as xe}from"./ProductModal-BfXuxU-a.js";import{A as pe}from"./arrow-left-CUel7EGd.js";import"./tslib.es6-D2mrdk48.js";import"./usePreventBodyScroll-D2l0Zfsl.js";import"./users-nAU_wbTa.js";import"./package-CJrhpnXf.js";const Se=()=>{const{id:j}=D(),S=ee(),[A]=te(),{data:a,error:U,isLoading:M,refetch:v}=de(j),{refetch:I}=le({page:1,limit:10}),[C,L]=o.useState(!1),[E,y]=o.useState(!1),[T,N]=o.useState(!1),[p,b]=o.useState([]),[g,f]=o.useState([]),[F,G]=o.useState(1),[H,Q]=o.useState(1),[O,R]=o.useState(!0),[B,V]=o.useState(!0),{data:k=[],isFetching:W}=se({page:F,limit:20}),{data:w=[],isFetching:q}=re({page:H,limit:20}),{control:c,handleSubmit:z,setValue:l,formState:{errors:s}}=ae({resolver:ne(xe),defaultValues:{couponCode:"",title:"",description:"",discount:"",minAmount:"",maxAmount:"",expiry:"",usageLimit:"",perUserLimit:1}});o.useEffect(()=>{j&&v()},[j,v]),o.useEffect(()=>{a&&(l("couponCode",a.coupon.couponCode),l("title",a.coupon.title),l("description",a.coupon.description),l("discount",a.coupon.discount.toString()),l("minAmount",a.coupon.minAmount.toString()),l("maxAmount",a.coupon.maxAmount.toString()),l("expiry",a.coupon.expiry.split("T")[0]),l("usageLimit",a.coupon.usageLimit?a.coupon.usageLimit.toString():""),l("perUserLimit",a.coupon.perUserLimit?a.coupon.perUserLimit.toString():"1"),b(a.coupon.applicableUsers.map(t=>({userId:t.id,username:t.email}))),f(a.coupon.applicableProducts.map(t=>({productId:t.id,productName:t.productName}))))},[a,l]);const J=async t=>{var i;L(!0);try{const r={...t,discount:Number(t.discount),minAmount:Number(t.minAmount),maxAmount:Number(t.maxAmount),usageLimit:t.usageLimit?parseInt(t.usageLimit):null,perUserLimit:t.perUserLimit?parseInt(t.perUserLimit):1,applicableUsers:p.map(h=>h.userId),applicableProducts:g.map(h=>h.productId)};await A({entity:"coupons",data:r,id:j}).unwrap(),await I(),P.success("Coupon updated successfully"),S(-1)}catch(r){console.error("Error during form submission:",r),P.error(((i=r==null?void 0:r.data)==null?void 0:i.message)||"An error occurred")}finally{L(!1)}},K=(t,i)=>{b(r=>r.some(x=>x.userId===t)?r.filter(x=>x.userId!==t):[...r,{userId:t,username:i}])},X=(t,i)=>{f(r=>r.some(x=>x.productId===t)?r.filter(x=>x.productId!==t):[...r,{productId:t,productName:i}])},Y=t=>{b(i=>i.filter(r=>r.userId!==t))},Z=t=>{f(i=>i.filter(r=>r.productId!==t))},_=o.useCallback(t=>{G(t),t>1&&R(!1)},[]),$=o.useCallback(t=>{Q(t),t>1&&V(!1)},[]);return M?e.jsx(ie,{}):U?e.jsxs("div",{children:["Error: ",U.message]}):e.jsx("div",{className:"dark:bg-black min-h-screen flex mt-10 items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-[1300px] dark:bg-gray-900 bg-orange-50 p-6 md:p-8 shadow-md",children:[e.jsxs("div",{className:"flex justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold dark:text-gray-400 text-gray-700",children:"Update Coupon"}),e.jsxs("button",{onClick:()=>S(-1),className:"flex items-center text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white",children:[e.jsx(pe,{className:"mr-2"}),e.jsx("span",{children:"Back to Coupons"})]})]}),e.jsxs("form",{onSubmit:z(J),children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4 mb-4",children:[e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Coupon Code *"}),e.jsx(m,{name:"couponCode",control:c,render:({field:t})=>e.jsx(u,{...t,type:"text",placeholder:"e.g., WELCOME50",className:"dark:text-white dark:bg-gray-800 uppercase"})}),s.couponCode&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.couponCode.message})]}),e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Coupon Title *"}),e.jsx(m,{name:"title",control:c,render:({field:t})=>e.jsx(u,{...t,type:"text",placeholder:"e.g., Welcome Offer",className:"dark:text-white dark:bg-gray-800"})}),s.title&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.title.message})]}),e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Expiry Date *"}),e.jsx(m,{name:"expiry",control:c,render:({field:t})=>e.jsx(u,{...t,type:"date",min:new Date().toISOString().split("T")[0],className:"dark:text-white dark:bg-gray-800"})}),s.expiry&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.expiry.message})]})]}),e.jsx("div",{className:"mb-4",children:e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Description *"}),e.jsx(m,{name:"description",control:c,render:({field:t})=>e.jsx(ce,{...t,placeholder:"Enter coupon description details...",rows:"3",className:"dark:text-white dark:bg-gray-800"})}),s.description&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.description.message})]})}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4 mb-4",children:[e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Discount (%) *"}),e.jsx(m,{name:"discount",control:c,render:({field:t})=>e.jsx(u,{...t,type:"number",placeholder:"1-70",min:"1",max:"70",className:"dark:text-white dark:bg-gray-800"})}),s.discount&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.discount.message})]}),e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Min Purchase Amount (₹) *"}),e.jsx(m,{name:"minAmount",control:c,render:({field:t})=>e.jsx(u,{...t,type:"number",placeholder:"₹500 - ₹1,00,000",min:"500",max:"100000",className:"dark:text-white dark:bg-gray-800"})}),s.minAmount&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.minAmount.message})]}),e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Max Discount Amount (₹) *"}),e.jsx(m,{name:"maxAmount",control:c,render:({field:t})=>e.jsx(u,{...t,type:"number",placeholder:"₹1 - ₹5,000",min:"1",max:"5000",className:"dark:text-white dark:bg-gray-800"})}),s.maxAmount&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.maxAmount.message})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-4",children:[e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Total Usage Limit"}),e.jsx(m,{name:"usageLimit",control:c,render:({field:t})=>e.jsx(u,{...t,type:"number",placeholder:"Leave empty for unlimited (e.g., 10 for first 10 people)",min:"1",className:"dark:text-white dark:bg-gray-800"})}),s.usageLimit&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.usageLimit.message}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:'Set this to limit total uses (e.g., "10" for first 10 people)'})]}),e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Per User Limit *"}),e.jsx(m,{name:"perUserLimit",control:c,render:({field:t})=>e.jsx(u,{...t,type:"number",placeholder:"1-5",min:"1",max:"5",className:"dark:text-white dark:bg-gray-800"})}),s.perUserLimit&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.perUserLimit.message}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"How many times each user can use this coupon"})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-6",children:[e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Target Audience"}),e.jsxs("select",{className:"w-full p-3 border rounded-md dark:text-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500",value:p.length>0?"specific":"all",onChange:t=>{t.target.value==="all"?b([]):y(!0)},children:[e.jsx("option",{value:"all",children:"All Users (Public)"}),e.jsx("option",{value:"specific",children:"Specific Users (Private)"})]}),p.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{onClick:()=>y(!0),className:"w-full p-3 border rounded-md dark:bg-gray-800 dark:text-white text-left cursor-pointer hover:border-orange-500 transition-colors",children:e.jsxs("span",{className:"font-semibold text-orange-600 dark:text-orange-400",children:[p.length," user(s) selected"]})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:p.map(t=>e.jsxs("span",{className:"inline-flex items-center bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 text-sm font-medium px-2.5 py-0.5 rounded",children:[t.username,e.jsx("button",{type:"button",onClick:i=>{i.stopPropagation(),Y(t.userId)},className:"ml-1.5 hover:text-red-500",children:"✕"})]},t.userId))})]})]}),e.jsxs(n,{children:[e.jsx(d,{className:"text-gray-700 dark:text-white",children:"Applicable Products"}),e.jsxs("select",{className:"w-full p-3 border rounded-md dark:text-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500",value:g.length>0?"specific":"all",onChange:t=>{t.target.value==="all"?f([]):N(!0)},children:[e.jsx("option",{value:"all",children:"All Products (Store-wide)"}),e.jsx("option",{value:"specific",children:"Specific Products"})]}),g.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{onClick:()=>N(!0),className:"w-full p-3 border rounded-md dark:bg-gray-800 dark:text-white text-left cursor-pointer hover:border-orange-500 transition-colors",children:e.jsxs("span",{className:"font-semibold text-orange-600 dark:text-orange-400",children:[g.length," product(s) selected"]})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:g.map(t=>e.jsxs("span",{className:"inline-flex items-center bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 text-sm font-medium px-2.5 py-0.5 rounded",children:[t.productName,e.jsx("button",{type:"button",onClick:i=>{i.stopPropagation(),Z(t.productId)},className:"ml-1.5 hover:text-red-500",children:"✕"})]},t.productId))})]})]})]}),e.jsx("div",{children:e.jsxs("button",{type:"submit",disabled:C,className:"w-full dark:bg-blue-600 bg-orange-500 text-white px-6 py-3 rounded-md dark:hover:bg-blue-700 hover:bg-orange-600 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(oe,{className:"mr-2"}),C?"Updating Coupon...":"Update Coupon"]})})]}),e.jsx(me,{showModal:E,setShowModal:y,users:(k==null?void 0:k.users)||[],handleUserSelect:K,selectedUsers:p,loadMoreUsers:_,hasMoreUsers:O,isUserFetching:W}),e.jsx(ue,{showModal:T,setShowModal:N,products:(w==null?void 0:w.products)||[],handleProductSelect:X,selectedProducts:g,loadMoreProducts:$,hasMoreProducts:B,isProductFetching:q})]})})};export{Se as default};
