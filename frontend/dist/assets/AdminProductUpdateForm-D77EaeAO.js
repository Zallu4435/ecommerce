import{u as Z,am as D,r as P,bg as ee,an as re,aW as ae,H as te,j as e,L as se,at as o,I as ie,bj as A,aL as w,B as h}from"./index-DNwfBDY0.js";import{I as ne,V as ce,p as de}from"./VariantBuilder-Do_vONtW.js";import{I as m,L as g,a as b,T as oe}from"./StyledComponents-BbiIQNic.js";import k from"./index-BBTKOM0z.js";import{A as le}from"./arrow-left-CUel7EGd.js";import{U as me}from"./upload-D2_odXxp.js";import"./index.module-DWjB8usZ.js";import"./tslib.es6-D2mrdk48.js";import"./zoom-out-62RsYA8A.js";import"./ConfirmDeleteModal-CHDRD4Zv.js";import"./usePreventBodyScroll-D2l0Zfsl.js";import"./plus-C5cYjQOd.js";import"./trash-2-D6jt9bEq.js";const Ie=()=>{const I=Z(),{id:f}=D(),[C,E]=P.useState(!1),[U,L]=P.useState([]),[T]=ee(),{data:l,error:S,isLoading:z}=re({id:f,includeInactive:"true"}),{data:j}=ae(),Q=(j==null?void 0:j.categories)||[],{control:d,handleSubmit:R,setValue:c,formState:{errors:t},watch:N,reset:ge,getValues:F}=te({resolver:ie(de),defaultValues:{productName:"",brand:"",category:"",description:"",basePrice:"",baseOfferPrice:"",returnPolicy:"",image:"",variants:[]}});P.useEffect(()=>{if(l!=null&&l.product){const{product:r}=l;c("productName",r.productName),c("brand",r.brand),c("category",r.category),c("description",r.description),c("basePrice",r.basePrice),c("baseOfferPrice",r.baseOfferPrice),c("returnPolicy",r.returnPolicy),c("image",r.image),r.variants&&r.variants.length>0&&(L(r.variants),c("variants",r.variants))}},[l,c]);const W=async(r,i)=>{var u,$,O;i.preventDefault(),E(!0);try{if(r.image&&(typeof r.image!="string"||r.image.startsWith("data:image"))){const p=await A(r.image);r.image=p.secureUrl,r.imagePublicId=p.publicId}const x={productName:r.productName,brand:r.brand,category:r.category,description:r.description,basePrice:r.basePrice,baseOfferPrice:r.baseOfferPrice,returnPolicy:r.returnPolicy,image:r.image,imagePublicId:r.imagePublicId};if(await T({entity:"products",data:x,id:f}).unwrap(),r.variants){const p=await Promise.all(r.variants.map(async a=>{if(a.image&&(typeof a.image!="string"||a.image.startsWith("data:image"))){const s=await A(a.image);return{...a,image:s.secureUrl,imagePublicId:s.publicId}}return a})),H=p.map(a=>a._id).filter(Boolean),q=U.filter(a=>!H.includes(a._id));for(const a of q)try{await k.delete(`${w}/variants/delete/${a._id}`)}catch(s){console.error(`Error deleting variant ${a._id}:`,s)}const J=p.filter(a=>a._id),V=p.filter(a=>!a._id);for(const a of J){const s=U.find(n=>n._id===a._id);let v=!0;if(s&&(v=s.color!==a.color||s.size!==a.size||Number(s.stockQuantity)!==Number(a.stockQuantity)||Number(s.price)!==Number(a.price)||Number(s.offerPrice)!==Number(a.offerPrice)||s.isActive!==a.isActive||s.image!==a.image||s.gender!==a.gender),!!v)try{const n={...a};n.gender&&(n.gender=n.gender.charAt(0).toUpperCase()+n.gender.slice(1).toLowerCase()),await k.put(`${w}/variants/update/${a._id}`,n)}catch(n){console.error(`Error updating variant ${a._id}:`,n),h.error(`Failed to update variant: ${a.sku||a.color}`)}}if(V.length>0)try{const a=await k.post(`${w}/variants/bulk-create`,{productId:f,variants:V});if(a.data.summary&&a.data.summary.failed>0){const s=a.data.summary.failed,n=(a.data.errors||[]).map(y=>{var _,B;const K=((_=y.data)==null?void 0:_.color)||"Unknown",X=((B=y.data)==null?void 0:B.size)||"Unknown",Y=y.errors?y.errors.join(", "):"Unknown error";return`${K}-${X}: ${Y}`}).join(`
`);h.warning(`${s} variant(s) failed to create:
${n}`,{autoClose:1e4})}}catch(a){console.error("Error creating new variants:",a),h.error((($=(u=a.response)==null?void 0:u.data)==null?void 0:$.message)||"Some new variants failed to create")}}h.success("Product updated successfully!"),I(-1)}catch(x){console.error("Error during form submission:",x),h.error(((O=x==null?void 0:x.data)==null?void 0:O.message)||"An error occurred")}finally{E(!1)}},G=N("basePrice"),M=N("baseOfferPrice");return z?e.jsx(se,{}):S?e.jsxs("div",{className:"text-red-500 p-4",children:["Error: ",S.message]}):e.jsx("div",{className:"dark:bg-black min-h-screen flex mt-10 items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-[1300px] dark:bg-gray-900 bg-orange-50 p-6 md:p-8 shadow-md",children:[e.jsxs("div",{className:"flex justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold mb-6 dark:text-gray-400 text-gray-700",children:"Update Product"}),e.jsxs("button",{onClick:()=>I(-1),className:"flex items-center text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white",children:[e.jsx(le,{className:"mr-2"}),e.jsx("span",{children:"Back to Products"})]})]}),e.jsxs("form",{onSubmit:R(W),children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4 mb-4",children:[e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Product Name *"}),e.jsx(o,{name:"productName",control:d,render:({field:r})=>e.jsx(b,{...r,type:"text",placeholder:"Enter product name",className:"dark:text-white dark:bg-gray-800"})}),t.productName&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.productName.message})]}),e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Brand *"}),e.jsx(o,{name:"brand",control:d,render:({field:r})=>e.jsx(b,{...r,type:"text",placeholder:"Enter Brand Name",className:"dark:text-white dark:bg-gray-800"})}),t.brand&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.brand.message})]}),e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Category *"}),e.jsx(o,{name:"category",control:d,render:({field:r})=>e.jsxs("select",{...r,className:"w-full p-3 border rounded-md dark:text-white dark:bg-gray-800",children:[e.jsx("option",{value:"",children:"Select category"}),Q.map(i=>e.jsx("option",{value:i.categoryName,children:i.categoryName},i._id))]})}),t.category&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.category.message})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-4",children:[e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Description *"}),e.jsx(o,{name:"description",control:d,render:({field:r})=>e.jsx(oe,{...r,placeholder:"Enter product description",rows:"4",className:"dark:text-white dark:bg-gray-800"})}),t.description&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.description.message})]}),e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Product Image *"}),e.jsx(o,{name:"image",control:d,render:({field:r})=>e.jsx(ne,{initialValue:r.value,onChange:r.onChange})}),t.image&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.image.message})]})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4 mb-4",children:[e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Base Price *"}),e.jsx(o,{name:"basePrice",control:d,render:({field:{onChange:r,...i}})=>e.jsx(b,{...i,type:"number",placeholder:"Enter base price",onChange:u=>r(Number(u.target.value)),className:"dark:text-white dark:bg-gray-800"})}),t.basePrice&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.basePrice.message})]}),e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Base Offer Price"}),e.jsx(o,{name:"baseOfferPrice",control:d,render:({field:{onChange:r,...i}})=>e.jsx(b,{...i,type:"number",placeholder:"Enter base offer price",onChange:u=>r(Number(u.target.value)),className:"dark:text-white dark:bg-gray-800"})}),t.baseOfferPrice&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.baseOfferPrice.message})]}),e.jsxs(m,{children:[e.jsx(g,{className:"text-gray-700 dark:text-white",children:"Return Policy *"}),e.jsx(o,{name:"returnPolicy",control:d,render:({field:r})=>e.jsx(b,{...r,type:"text",placeholder:"Enter Return Policy",className:"dark:text-white dark:bg-gray-800"})}),t.returnPolicy&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:t.returnPolicy.message})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx(o,{name:"variants",control:d,render:({field:r})=>{var i;return e.jsx(ce,{variants:r.value,onChange:r.onChange,basePrice:G,baseOfferPrice:M,category:N("category")||F("category")||((i=l==null?void 0:l.product)==null?void 0:i.category)})}}),t.variants&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:t.variants.message})]}),e.jsx("div",{children:e.jsxs("button",{type:"submit",disabled:C,className:"w-full dark:bg-blue-600 bg-orange-500 text-white px-6 py-3 rounded-md dark:hover:bg-blue-700 hover:bg-orange-600 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(me,{className:"mr-2"}),C?"Updating Product...":"Update Product"]})})]})]})})};export{Ie as default};
